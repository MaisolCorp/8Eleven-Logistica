<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Gestión de Puntos de Venta - 8Eleven</title>
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/sb-admin-2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>

<body id="page-top">
    <div id="wrapper">

        <div id="sidebar"></div>

        <div id="content-wrapper" class="d-flex flex-column">
            <div id="content">

                <div id="topbar"></div>

                <div class="container mt-5">
                    <h1 class="h3 mb-2 text-gray-800">Gestión de Puntos de Venta</h1>

                    <div class="card shadow mb-4">
                        <div class="card-body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>País</th>
                                        <th>Estado</th>
                                        <th>Municipio</th>
                                        <th>C.P</th>
                                        <th>Nombre</th>
                                        <th>Zona</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaPuntosVentas">
                                    <!-- Aquí se cargarán dinámicamente los puntos de venta -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
            <footer class="sticky-footer bg-white">
            </footer>
        </div>
    </div>

    <div class="modal fade" id="editarPuntoVentaModal" tabindex="-1" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Editar Punto de Venta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modalBody">
                    <div id="detallePuntoVentaContent"></div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="pais" class="form-label">País</label>
                            <input type="text" class="form-control" id="pais" placeholder="Ingrese el país" required>
                        </div>
                        <div class="mb-3">
                            <label for="estado" class="form-label">Estado</label>
                            <input type="text" class="form-control" id="estado" placeholder="Ingrese el estado"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="municipio" class="form-label">Municipio</label>
                            <input type="text" class="form-control" id="municipio" placeholder="Ingrese el municipio"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="cp" class="form-label">Código Postal (C.P)</label>
                            <input type="text" class="form-control" id="cp" placeholder="Ingrese el código postal"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="nombre" class="form-label">Nombre del Punto de Venta</label>
                            <input type="text" class="form-control" id="nombre"
                                placeholder="Ingrese el nombre del punto de venta" required>
                        </div>
                        <div class="mb-3">
                            <label for="zona" class="form-label">Zona</label>
                            <input type="text" class="form-control" id="zona" placeholder="Ingrese la zona" required>
                        </div>
                        <div class="container-fluid">
                            <div class="row">
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                        data-bs-dismiss="modal">Cerrar</button>
                                    <button type="button" class="btn btn-primary"
                                        onclick="actualizarPuntoVenta()">Actualizar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <script>

                        const swalWithBootstrapButtons = Swal.mixin({
                            customClass: {
                                confirmButton: "btn btn-success m-2",
                                cancelButton: "btn btn-danger"
                            },
                            buttonsStyling: false
                        });
                        fetch('sidebar.html?' + new Date().getTime())
                            .then(response => response.text())
                            .then(data => {
                                document.getElementById('sidebar').innerHTML = data;
                            });

                        fetch('topbar.html?' + new Date().getTime())
                            .then(response => response.text())
                            .then(data => {
                                document.getElementById('topbar').innerHTML = data;
                            });

                        function cargarDetallePuntoVenta(nombrePuntoVenta) {
                            fetch(`https://8eleven.glitch.me/puntosVentasRoutes/detalle-punto-venta/${encodeURIComponent(nombrePuntoVenta)}`)
                                .then(response => response.json())
                                .then(data => {
                                    const detallePuntoVentaContent = document.getElementById('detallePuntoVentaContent');
                                    detallePuntoVentaContent.innerHTML = '';
                                    document.getElementById('pais').value = data.pais;
                                    document.getElementById('estado').value = data.estado;
                                    document.getElementById('municipio').value = data.municipio;
                                    document.getElementById('cp').value = data.cp;
                                    document.getElementById('nombre').value = data.nombre;
                                    document.getElementById('zona').value = data.zona;

                                    $('#detallePuntoVentaModal').modal('show'); // Abre el modal después de cargar los detalles
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    alert('Error al cargar los detalles del punto de venta');
                                });
                        }

                        function actualizarPuntoVenta() {
                            const formData = {
                                pais: document.getElementById('pais').value,
                                estado: document.getElementById('estado').value,
                                municipio: document.getElementById('municipio').value,
                                cp: document.getElementById('cp').value,
                                nombre: document.getElementById('nombre').value,
                                zona: document.getElementById('zona').value,
                            };
                            fetch('https://8eleven.glitch.me/puntosVentasRoutes/actualizar-punto-venta', {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(formData)
                            })
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error(`HTTP error! Status: ${response.status}`);
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    console.log(data);
                                    // Utiliza SweetAlert para mostrar un mensaje de éxito
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Punto de venta actualizado exitosamente',
                                        showConfirmButton: false,
                                        timer: 1500
                                    }).then(() => {
                                        // Cierra el modal y recarga la lista de puntos de venta
                                        $('#editarProductoModal').modal('hide');
                                        cargarPuntosVentas();
                                    });
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    // Utiliza SweetAlert para mostrar un mensaje de error
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error',
                                        text: 'Error en la actualización del punto de venta'
                                    });
                                });
                        }


                        function cargarPuntosVentas() {
                            fetch('https://8eleven.glitch.me/puntosVentasRoutes/listar-puntos-ventas')
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error(`HTTP error! Status: ${response.status}`);
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    const tablaPuntosVentas = document.getElementById('tablaPuntosVentas');
                                    tablaPuntosVentas.innerHTML = '';

                                    data.forEach(puntoVenta => {
                                        const fila = `<tr>
                    <td>${puntoVenta.pais}</td>
                    <td>${puntoVenta.estado}</td>
                    <td>${puntoVenta.municipio}</td>
                    <td>${puntoVenta.cp}</td>
                    <td>${puntoVenta.nombre}</td>
                    <td>${puntoVenta.zona}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal"
                        data-bs-target="#editarPuntoVentaModal"
                        onclick="cargarDetallePuntoVenta('${puntoVenta.nombre}')">Editar</button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="eliminarPuntoVenta('${puntoVenta.nombre}')">Eliminar</button>
                    </td>
                </tr>`;
                                        tablaPuntosVentas.innerHTML += fila;
                                    });
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    // Utiliza SweetAlert para mostrar un mensaje de error al cargar la lista de puntos de venta
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error',
                                        text: 'Error al cargar la lista de puntos de venta'
                                    });
                                });
                        }


                        function eliminarPuntoVenta(nombre) {
                            // Utiliza SweetAlert para confirmar la eliminación
                            Swal.fire({
                                title: '¿Estás seguro?',
                                text: 'Esta acción no se puede deshacer',
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonColor: '#d33',
                                cancelButtonColor: '#3085d6',
                                confirmButtonText: 'Sí, eliminarlo'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    // Si el usuario confirma la eliminación, realiza la solicitud DELETE
                                    fetch(`https://8eleven.glitch.me/puntosVentasRoutes/eliminar-punto-venta/${nombre}`, {
                                        method: 'DELETE'
                                    })
                                        .then(response => {
                                            if (!response.ok) {
                                                throw new Error(`HTTP error! Status: ${response.status}`);
                                            }
                                            return response.json();
                                        })
                                        .then(data => {
                                            console.log(data);
                                            // Utiliza SweetAlert para mostrar un mensaje de éxito
                                            Swal.fire({
                                                icon: 'success',
                                                title: 'Punto de venta eliminado exitosamente',
                                                showConfirmButton: false,
                                                timer: 1500
                                            }).then(() => {
                                                // Recarga la lista después de eliminar
                                                cargarPuntosVentas();
                                            });
                                        })
                                        .catch(error => {
                                            console.error('Error:', error);
                                            // Utiliza SweetAlert para mostrar un mensaje de error
                                            Swal.fire({
                                                icon: 'error',
                                                title: 'Error',
                                                text: 'Error al eliminar el punto de venta'
                                            });
                                        });
                                }
                            });
                        }


                        cargarPuntosVentas();
                    </script>

                    <script src="vendor/jquery/jquery.min.js"></script>
                    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
                    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>
                    <script src="js/sb-admin-2.min.js"></script>
                    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>